<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TRVE vs Offres de marché — Base 36 kVA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{margin:0;overflow:hidden;background:#fff;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;justify-content:center;padding:40px 16px;}
    .chart-wrapper{background:transparent;border-radius:0;box-shadow:none;padding:0;}
    h1{margin:0 0 14px;text-align:center;font-size:22px;font-weight:600;color:#0b0f19;}
    .legend-note{margin:2px 0 12px;text-align:center;color:#64748b;font-size:13px;}
    canvas{width:100% !important;height:auto !important;}
  </style>
</head>
<body>
  <div class="chart-wrapper">
    <h1>Évolution du prix du kWh — TRVE vs Offres de marché</h1>
    <div class="legend-note">Profil professionnel • Base 36 kVA • Unités : €/kWh <strong>TTC</strong></div>
    <canvas id="chart"></canvas>
  </div>

  <script>
    const trveUrl = "https://raw.githubusercontent.com/FEPPN/graph_historical_TRVE/main/data.json";
    const competitorsUrl = "https://raw.githubusercontent.com/FEPPN/competitors-pro-kwh-graph/main/data_competitors_pro.json";

    // Fenêtre temporelle stricte demandée
    const START_AT = "2024-07"; // Juillet 2024
    const END_AT   = "2025-10"; // Octobre 2025

    const ymKey = d => { const dt=new Date(d); return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0"); };
    const ymToLabel = k => { const [y,m]=k.split("-"); return new Date(+y,+m-1,1).toLocaleDateString("fr-FR",{year:"numeric",month:"2-digit"}); };

    // Génère la liste continue des AAAA-MM entre START_AT et END_AT (inclus)
    function monthRange(startYm, endYm){
      const [sy, sm] = startYm.split("-").map(Number);
      const [ey, em] = endYm.split("-").map(Number);
      const res = [];
      let y = sy, m = sm;
      while (y < ey || (y === ey && m <= em)) {
        res.push(y + "-" + String(m).padStart(2,"0"));
        m++; if (m > 12) { m = 1; y++; }
      }
      return res;
    }

    Promise.all([
      fetch(trveUrl+"?v="+Date.now(),{cache:"no-store"}).then(r=>r.json()),
      fetch(competitorsUrl+"?v="+Date.now(),{cache:"no-store"}).then(r=>r.json())
    ])
    .then(([trveRows, compRows])=>{
      // --- TRVE : points ponctuels -> série mensuelle (carry-forward) ---
      const trvePoints = (trveRows || [])
        .filter(r => r.Date && (typeof r.BASE === "number" || typeof r.AVG === "number"))
        .map(r => [ymKey(r.Date), (typeof r.BASE === "number") ? r.BASE : r.AVG])
        .sort((a,b) => a[0].localeCompare(b[0]));

      const months = monthRange(START_AT, END_AT);

      // Dernière valeur connue <= mois k
      const valueAtMonth = (k) => {
        let last = null;
        for (const [kk, vv] of trvePoints) {
          if (kk <= k) last = vv; else break;
        }
        return last;
      };

      const labels   = months.map(ymToLabel);
      const trveVals = months.map(valueAtMonth);

      // --- Concurrents : alignés sur les mêmes months ---
      const compIdx = {};
      (compRows||[]).forEach(r=>{
        const v = (typeof r.CompetitorAVG_BASE==="number") ? r.CompetitorAVG : Number(String(r.CompetitorAVG).replace(",","."));
        if(!Number.isNaN(v) && r.Date) compIdx[ymKey(r.Date)] = v;
      });
      const compVals = months.map(k => (k in compIdx ? compIdx[k] : null));

      const ctx = document.getElementById("chart").getContext("2d");

      const gTrve = ctx.createLinearGradient(0,0,0,300);
      gTrve.addColorStop(0,"rgba(90, 82, 255, 0.22)");
      gTrve.addColorStop(1,"rgba(90, 82, 255, 0.00)");

      new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {
              label:"TRVE – Tarif réglementé (Base 36 kVA)",
              data: trveVals,
              borderColor:"#5a52ff",
              backgroundColor:gTrve,
              borderWidth:1.6,
              pointRadius:0,
              spanGaps:true,
              stepped:'before',   // TRVE en escalier
              tension:0,
              fill:false
            },
            {
              label:"Prix moyen offres de marché (Engie • TotalEnergies • OHM Énergie • Primeo Énergie)",
              data: compVals,
              borderColor:"#334155",
              backgroundColor:"transparent",
              borderWidth:1.6,
              borderDash:[6,4],
              pointRadius:0,
              spanGaps:true,
              stepped:false,
              tension:0.25,
              fill:false
            }
          ]
        },
        options:{
          responsive:true,
          interaction:{ mode:'nearest', intersect:false },
          plugins:{
            legend:{
              position:"bottom",
              labels:{ color:"#1f2937", font:{ size:13, weight:"600" } }
            },
            tooltip:{
              backgroundColor:"#fff", borderColor:"#e5e7eb", borderWidth:1,
              titleColor:"#111827", bodyColor:"#4b5563",
              titleFont:{ weight:'700' }, bodyFont:{ weight:'500' },
              padding:10, cornerRadius:10,
              callbacks:{
                label:(ctx)=>{
                  const y = ctx.parsed.y;
                  if (typeof y !== "number") return `${ctx.dataset.label} : —`;
                  return `${ctx.dataset.label} : ${y.toFixed(4).replace('.',',')} € / kWh TTC`;
                }
              }
            }
          },
          scales:{
            y:{
              min: 0.1, // démarre à 0,100 €
              ticks:{
                color:"#6b7280",
                callback:v=>`${Number(v).toFixed(3).replace('.',',')} €`
              },
              grid:{ color:"rgba(0,0,0,0.06)" },
              border:{ display:false }
            },
            x:{
              offset:true,
              ticks:{ color:"#6b7280", maxRotation:0, autoSkip:true, maxTicksLimit:12 },
              grid:{ display:false },
              border:{ display:false }
            }
          }
        }
      });
    })
    .catch(err=>{
      console.error(err);
      document.querySelector(".chart-wrapper").insertAdjacentHTML("beforeend",
        `<p style="margin-top:10px;color:#ef4444;text-align:center">Erreur de chargement des données.</p>`);
    });
  </script>
</body>
</html>
